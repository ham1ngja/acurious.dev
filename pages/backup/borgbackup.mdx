# borgbackup

Having lost small amounts of data in the past, due to hard drive failures and the like, I have implemented an automated backup system that keeps all of my important files safe and disseminates them to various locations, to avoid catastrophic data loss due to issues such as fire, theft, or mechanical failure, just to name a few.

## Why Borgbackup?

I've looked at a few options, but Borg stuck out for a few reasons. One being reliability, and the other being the fact that it does deduplication. In other words, it doesn't save full files over and over, but whenever you make a modification, it only saves what has been modified, thus saving you space.

For example, if you're working on a document, and you add a few lines to it, the Borg won't backup the full file again, but just the new lines you typed in today. This saves a tremendous amount of space over time.

## Installation

I'm on macOS, so I'll cover the steps that I took. If you want to run it on Linux, I'm sure the steps will be fairly similar, apart from the fact that you'd be using a different packet manager. 

To install borgbackup, you first need to install Homebrew, which is a macOS packet manager. If you want to read more about brew, I've covered it in [a different article](/macos/brew).


```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

This is the command to do so. Once you have installed it, it's time to install borgbackup.

```bash
brew install borgbackup
```

This should be straightforward enough. Next up, creating a repository. A repo is a special file which will contain all of your backups, in the form of snapshots. If you need to recover a file as it was at a certain point in time, you interact with that file, and extract the appopriate archive. We'll talk about that a bit later on.

## Create Repo

```bash
borg init --encryption=repokey /path/to/repo
```

This creates a new repo and uses lz4 compression by default. There are quite a few arguments you can pass to borgbackup. I'm going to cover the main ones here. If you'd like to learn more about it, you can do `man borg`

### Add Archive to Repo

```bash
borg create --stats --progress ~/borg::'local-{now:%Y-%m-%d-%H%M%S}'
```

This creates a new archive named after the current time and date. You can type in anything after :: and that would be the name otherwise. You don't have to do it this way, as you can name your archives anything you like. I like this format, so that's what I'm using.

In regards to the name of the repo, mine is simply called `borg` in this example. On my machine, I actually have two, named `borg.local` and `borg.cloud`, but we'll get into that a bit later on.

### Show Archives in Repo

```bash
borg list ~/borg
```

This command will show you all of the archives present in the repo. The command in the previous chapter names them logically, and the backups are created automatically, so you should be able to easily find the one you need to extract.

### Extra Repo Info

```bash
borg list ~/borg
```

This will give more information on the repo if needed.

### Extract Archive

```bash
borg extract ~/borg::local-2024-06-02-061006
```

This is an example of how extraction works. After using `borg list`, you can then extract the entire archive. This will extract the full archive in the current directory.

Bear in mind that the archive that you specify is essentially a snapshot in time. It will recreate your files as they were when that backup was made. Alternatively, we can use this command to extract a specific directory from the archive.

```bash
borg extract ~/borg::local-2024-06-02-061006 /path/to/extract
```

### Add Password to Keychain

To not have to type in the password each time you run a backup, you can save it to the Keychain, and then retrieve it with the script. This is macOS-specific. I'm sure Linux probably has something similar.

```bash
security add-generic-password -a borg -s BorgBackup -w 'your_password_here'
```

## The Script

Ok, so now that I've covered all of this, I'll show you the script that I use. It's a pretty straightforward bash script which does a few things.

I'll first drop it in its entirety here, but I'll then go bit by bit after, and explain what each portion of the code does. If you want to use the script, but you're not very familiar with Borg or bash scripting, I recommend you read the step-by-step portion below.

```bash
#!/bin/bash

echo -e "\n[$(date +"%T")] Local Borg Backup Initialising.\n"

echo "Backing up Brewfile..."

rm -f ~/.config/brew/Brewfile && brew bundle dump --file=~/.config/brew/Brewfile

echo -e "Brewfile has been backed up.\n"

paths=(
"/path"
"/more/paths"
)

BORG_PASSPHRASE=$(security find-generic-password -a borg -s BorgBackup -w) borg create --stats --progress ~/borg/borg.local::'local-{now:%Y-%m-%d-%H%M%S}' "${paths[@]}"

rsync -av --delete ~/borg/borg.local "/Volumes/borg" ; rsync -av --delete ~/borg/borg.local "/Volumes/borg.ssd"

echo -e "\n[$(date +"%T")] Local Borg Backup Complete. \n\n"
```

I know this might look intimidating at first glance, but let's go through it step by step, so that you understand what it does.

### Initialisation Echo

```bash
echo -e "\n[$(date +"%T")] Local Borg Backup Initialising.\n"
```

This prints the first message we see, adding the current time at the start of the message. This is incredibly useful, as it allows us to easily keep track of when an update was initialised.

### Brew Backup

```bash
rm -f ~/.config/brew/Brewfile && brew bundle dump --file=~/.config/brew/Brewfile
```

Now, if you want to back up your brew apps, you can just have a look inside of the `/opt` directory, however, maybe you don't have the space to spare, and you just want a list of apps, that you can easily use to re-install later.

`brew bundle dump` does exactly that. This script saves it to `~/.config/brew/Brewfile`, but first, it removes the older version of that file if it is already there, and it does so without asking for confirmation.

### Restore Brewfile

When you want to restore the Brewfile, all you need to do is this.

```bash
brew bundle --file=~/.config/brew/Brewfile
```

### File Paths

```bash
paths=(
"/path"
"/more/paths"
)
```

Ok, so what does this bit do? It allows you to add a bunch of paths in a human-readable way. Initially, the script didn't involve an array, so I had to have all paths like this:

```bash
"path1" "path2" "path3"
```

As you might imagine, that got messy very quickly. If you add them in an array, you can have one on each line, thus making it a lot easier to keep track of everything. You can even have empty lines between the lines, to visually separate things.

You can back up either files or directories, in whatever order you deem logical.

### Perform Backup

```bash
BORG_PASSPHRASE=$(security find-generic-password -a borg -s BorgBackup -w) borg create --stats --progress ~/borg/borg.local::'local-{now:%Y-%m-%d-%H%M%S}' "${paths[@]}"
```

Ok, this one looks a bit scary, so let's dig in. The first bit of it, up until `-w)` retrieves the password from the macOS keychain. I've explained how to save it earlier in this article.

The point of this is to avoid having to type in the password every time you want to do a backup. The second part of the code is what creates the actual archive within the repo. It uses the current date and time to name it.

Then, we have `"${paths[@]}"`. This tells the script to backup all of the paths mentioned in the array above.

### Dissemination

Ok, so you've made your local backup. That's great, but you should probably make a few copies of it. In this case, I use rsync. If you don't already have it installed, you can do so with `brew install rsync`.

```bash
rsync -av --delete ~/borg/borg.local "/Volumes/borg" ; rsync -av --delete ~/borg/borg.local "/Volumes/borg.ssd"
```

In this case, this command makes two copies, one on an SD card, and one on an external SSD. If you want, you can even make a copy to iCloud, if you want a cloud backup.

### Cloud Backups

In my case, I have two borg backups. One is local, and one is for the cloud. The local one is much larger, and the cloud one is very lightweight. The cloud repo gets copied to my iCloud, using rsync, and it also gets backed up with a couple more cloud services.

This is not supposed to be an endorsement of any cloud service, so I won't mention the ones I use. It is up to you to do your research, and decide which you want to pick.

## Backup Automation

Now, the `backup.sh` script that I use is useful for one-off backups. If you want to automate the backups every few hours, you can either use cron jobs, or you can use a simpler method. I don't know which one is better.

Mine involves a bit more faff, as I have to re-run it every time I reboot (which isn't that often), but I can easily cancel it if I need to. I have a second .sh file, which looks like this.

```bash
#!/bin/bash

while true; do

	bash "/path/to/backup.sh"

echo -e "The next backup will run at [$(date -v +4H +"%T")]\n"

	sleep 14400

done
```

### Loop

The while true loop just runs forever, until you cancel the script.

### Run

```bash
bash "/path/to/backup.sh"
```

This runs the main script, which does all of the actual backing up.

### Echo

```bash
echo -e "The next backup will run at [$(date -v +4H +"%T")]\n"
```

This prints when the next backup will take place. It pulls the current time, and it adds 4 hours to it, as I like to do my backups every 4 hours.

### Sleep

```bash
sleep 14400
```

This bit tells the script to wait 14400 seconds, which is 240 minutes, or 4 hours. Once the time has elapsed, it goes through the while loop again.

I'm sure there's a much more big-brained way of doing this, but sometimes, when you're prototyping something, you just need to get it to work. I can always improve upon the design at a later date.

### Permissions

If running either script does not work, make sure you make the script executable by doing `chmod +x backup.sh`, and then try again.

## Conclusion

In conclusion, my important data is backed up on my computer, an SD card, and an external SSD, as well as on a few cloud services. This is a reasonable amount of protection for most people. You can always do a lot more, but sometimes, you need to find a balance between security and convenience, and in my case, this works great.
